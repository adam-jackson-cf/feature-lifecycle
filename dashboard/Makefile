# Generated by setup-dev-monitoring on 2024-11-29
.PHONY: help dev status logs clean-logs run-DASHBOARD lint typecheck test-unit test-integration-fast quality-gates

# Default target
.DEFAULT_GOAL := quality-gates

# Logging configuration
LOG_FILE ?= ./dev.log

define PIPE_TS
2>&1 | while IFS= read -r line; do \
	echo "[$$(date '+%H:%M:%S')] [$(1)] $$line"; \
done | tee -a $(LOG_FILE)
endef

# Colors for output
GREEN := \033[0;32m
YELLOW := \033[0;33m
RED := \033[0;31m
NC := \033[0m # No Color

help: ## Show this help message
	@echo "Available targets:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-20s$(NC) %s\n", $$1, $$2}'

# =============================================================================
# Development Server Targets
# =============================================================================

dev: run-DASHBOARD ## Start all services (parallel)

status: ## Show service processes
	@ps aux | grep -E "node|bun|next" | grep -v "grep" || true

logs: ## Tail unified log
	@touch $(LOG_FILE)
	@tail -f $(LOG_FILE)

clean-logs: ## Truncate logs
	@: > $(LOG_FILE)

run-DASHBOARD: ## Start Next.js dashboard (port 3000)
	@echo "$(YELLOW)Starting Dashboard on port 3000...$(NC)"
	@PORT=3000 bun run dev -- --port 3000 $(call PIPE_TS,DASHBOARD)

# =============================================================================
# Quality Gate Targets
# =============================================================================

lint: ## Run linting checks
	@echo "$(YELLOW)Running linting checks...$(NC)"
	@bun run lint
	@echo "$(GREEN)✓ Linting passed$(NC)"

typecheck: ## Run TypeScript type checking
	@echo "$(YELLOW)Running TypeScript type checking...$(NC)"
	@bun run typecheck
	@echo "$(GREEN)✓ Type checking passed$(NC)"

test-unit: ## Run unit tests
	@echo "$(YELLOW)Running unit tests...$(NC)"
	@bun run test:unit
	@echo "$(GREEN)✓ Unit tests passed$(NC)"

test-integration-fast: ## Run integration tests (excluding slow tests)
	@echo "$(YELLOW)Running fast integration tests...$(NC)"
	# Note: When slow tests are added, mark them with .skip() or use --testNamePattern to exclude
	# Example: --testNamePattern="^(?!.*slow).*" to exclude tests with "slow" in the name
	@bun run test:integration -- --reporter=verbose --testNamePattern="^(?!.*\\[slow\\]).*"
	@echo "$(GREEN)✓ Fast integration tests passed$(NC)"

quality-gates: lint typecheck test-unit test-integration-fast ## Run all quality gates (lint, typecheck, unit tests, fast integration tests)
	@echo ""
	@echo "$(GREEN)========================================$(NC)"
	@echo "$(GREEN)  All quality gates passed! ✓$(NC)"
	@echo "$(GREEN)========================================$(NC)"
